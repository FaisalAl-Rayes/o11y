evaluation_interval: 1m

rule_files:
  - prometheus.performance_alerts.yaml

tests:
  # Etcd Alerts
  - interval: 1m
    input_series:
      # Increase in Etcd raft proposal failures over time, so it will be alerted.
      - series: 'etcd_server_proposals_failed_total{pod="etcd-pod-1"}'
        values: '0+5x59'  # Total Memory on Node

    alert_rule_test:
      - eval_time: 1h
        alertname: EtcdProposalFailures
        exp_alerts:
          - exp_labels:
              severity: warning
              pod: etcd-pod-1
            exp_annotations:
              summary: "ETCD raft proposal failures."
              description: "Etcd high number of failed proposals on pod etcd-pod-1"

  - interval: 1m
    input_series:
      # Etcd raft proposals failures within threshold limit, so it will not be alerted.
      - series: 'etcd_server_proposals_failed_total{pod="etcd-pod-1"}'
        values: '0+5x30 1+0x29'  # Total Memory on Node

    alert_rule_test:
      - eval_time: 1h
        alertname: EtcdProposalFailures


  # Node based Alerts
  - interval: 1m
    input_series:
      # Node is running with 98% memory usage, so it will be alerted.
      - series: 'node_memory_MemTotal_bytes{instance="instance1"}'
        values: '100+0x9'  # Total Memory on Node
      - series: 'node_memory_MemAvailable_bytes{instance="instance1"}'
        values: '2+0x9'  # Free Memory on Node

    alert_rule_test:
      - eval_time: 10m
        alertname: NodeHighMemory
        exp_alerts:
          - exp_labels:
              severity: warning
              instance: instance1
            exp_annotations:
              summary: "Node High Memory Usage."
              description: "Memory Usage is above 98% on node instance1"

  - interval: 1m
    input_series:
      # Node is running under 90% memory usage, so it will not be alerted.
      - series: 'node_memory_MemTotal_bytes{instance="instance2"}'
        values: '100x9'  # Total Memory on Node
      - series: 'node_memory_MemAvailable_bytes{instance="instance2"}'
        values: '98x9'   # Free Memory on Node

    alert_rule_test:
      - eval_time: 10m
        alertname: NodeHighMemory
